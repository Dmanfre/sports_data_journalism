```{r}

library(tidyverse)
library(janitor)
library(lubridate)
#install.packages("remotes")
#remotes::install_github("slu-openGIS/postmastr")
library(postmastr)
library(usdata)
library(rvest)
```

```{r}
# Loading data for the seaosns
logs24 <- read_csv("https://thescoop.org/sports-data-files/wbblogs24.csv")
logs18_24 <- read_csv("https://www.thescoop.org/sports-data-files/wbblogs1824.csv")

# removing the 2023-2024 from logs_18_24 to avoid duplicates when binding. Final product should have the first few games of 23-24 season.
logs18_24 <- logs18_24 %>% 
  filter(Season != "2023-2024")

logs <- logs18_24 %>% 
  bind_rows(logs18_24, logs24)

# Loading player data from 2022-2023
wbb23_24_rosters <- read_csv("data/wbb_rosters_2023_24.csv")
wbb22_23_rosters <- read_csv("data/wbb_rosters_2022_23.csv")

```

The countries that need to be cleaned are "The Netherlands and BOSNIA AND HERZEGOVINA"
NOTE: I replaced the 23_24 file with the one Derek updated: this is a link to the file. https://github.com/Sports-Roster-Data/womens-college-basketball/blob/main/wbb_rosters_2023_24.csv
```{r}
wbb22_23_rosters <- wbb22_23_rosters %>% 
  mutate(
    country_clean = case_when(
      country_clean == "THE NETHERLANDS" ~ "NETHERLANDS",
      country_clean == "BOSNIA AND HERZEGOVINA" ~ "BOSNIA & HERZEGOVINA",
      TRUE ~ as.character(country_clean)))
```

Creating power 5 list
```{r}
power_5 <- c("ACC", "Big 12", "Big Ten", "Pac-12", "SEC")
```

Filtering for non us players
```{r}
non_us_22_23 <- wbb22_23_rosters %>%
filter(country_clean != "USA", division == "I")
  
non_us_23_24 <-  wbb23_24_rosters %>% 
  filter(country_clean != "USA", division == "I")
```

What I want to do here is answer the obvious questions and generate dfs for each question showing the 22-23, the 23-24, diffs and percentage changes. 

createing teams datafraems
```{r}
#23-24
teams_with_int_players_23_24 <- non_us_23_24 %>% 
  group_by(team, conference) %>% 
  summarize(int_players = n()) %>% 
  arrange(desc(int_players))

#22-23
teams_with_int_players_22_23 <- non_us_22_23 %>% 
  group_by(team, conference) %>% 
  summarize(int_players = n()) %>% 
  arrange(desc(int_players))

# total players
total_player_23_24 <-  wbb23_24_rosters %>% 
  filter(division == "I") %>% 
  group_by(team, conference) %>% 
  summarize(total_players = n()) %>% 
  arrange((team))

total_player_22_23 <- wbb22_23_rosters %>% 
  filter(division == "I") %>% 
  group_by(team, conference) %>% 
  summarize(total_players = n()) %>% 
  arrange((team))
```


# need to figure out a new way to get a clean version of all players.

# I need to do the anti joins in seperate years and then do the mutates for the NA values, then inner joins back together. 

```{r}
 
all_players23_24 <- anti_join(teams_with_int_players_23_24, total_player_23_24, by = "team")

all_players22_23 <- anti_join(teams_with_int_players_22_23, total_player_22_23, by = "team")

all_players <- inner_join(all_players23_24, all_players22_23, by = "team")

```


# Everything below this was done before I discovered the discrepency. So everything above is what is needed to form the all_players dataframe. 





adding in percentages
```{r}
# Percentage change doesn't show anything interesting here. Percentages does.

all_players <- all_players %>% 
  mutate(int_player_perc_23_24 = int_players_23_24/total_players_23_24*100,
         int_player_perc_22_23 = int_players_22_23/total_players_22_23*100,
         int_perc_change = (int_players_23_24-int_players_22_23)/int_players_22_23)
```

player count categories
```{r}
all_players_categories <- all_players %>%
  mutate(
    category_22_23 = case_when(
        int_players_22_23 < 5 ~ "Less than 5",
        int_players_22_23 >= 5 & int_players_22_23 <= 10 ~ "Between 5 and 10 players",
        int_players_22_23 > 10 ~ "Greater than 10 players")) %>% 
  mutate(category_23_24 = case_when(
        int_players_23_24 < 5 ~ "Less than 5",
        int_players_23_24 >= 5 & int_players_23_24 <= 10 ~ "Between 5 and 10 players",
        int_players_23_24 > 10 ~ "Greater than 10 players"))
```

 Category counts
```{r}
categories_23_24 <- all_players_categories %>% 
  group_by(category_23_24 ) %>% 
  summarize(number_of_teams = n())

categories_22_23 <- all_players_categories %>% 
  group_by(category_22_23) %>% 
  summarize(number_of_teams = n())
```


------- Data Exploration Section -----------

Here I will answer the obvious outstanding questions and try to formulate a story narrative after it.

Which conference has most players
```{r}
by_conf <- all_players %>% 
  group_by(conference) %>% 
  summarise(int_players_23_24 = sum(int_players_23_24),
            int_players_22_23 = sum(int_players_22_23)) %>% 
  mutate(conf_int_perc_23_24 = int_players_23_24/sum(int_players_23_24)*100,
         conf_int_perc_22_23 = int_players_22_23/sum(int_players_22_23)*100)

# Filtering for the conference allowes you to see a team's percentage of the conferences international players.
all_players %>%
  filter(conference == "AAC") %>% 
  summarise(total_int_players = sum(int_players_23_24)) %>% 
  mutate(team_perc_of_conf = total_int_players/sum(total_int_players)*100) %>% 
  arrange(desc(total_int_players))

teams_with_int_players_23_24 %>%
  filter(conference == "AAC")
```





